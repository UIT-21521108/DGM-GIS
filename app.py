# -*- coding: utf-8 -*-
"""Untitled18.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Olm0h0s8ZF-EuEKsKb5vSr_pLvnxdt9_
"""

# app.py
# Web app Streamlit tÃ­nh tá»•ng chiá»u dÃ i máº¡ng lÆ°á»›i Ä‘Æ°á»ng (KMU) tá»« OpenStreetMap
# Dá»±a trÃªn thuáº­t toÃ¡n trong notebook cá»§a báº¡n (OSMnx: graph_from_place + basic_stats)

import streamlit as st
import osmnx as ox
import matplotlib.pyplot as plt

# Cáº¥u hÃ¬nh chung cho OSMnx
ox.settings.use_cache = True          # cache Ä‘á»ƒ tÄƒng tá»‘c cÃ¡c láº§n cháº¡y sau
ox.settings.log_console = False

st.set_page_config(page_title="Äá»™ dÃ i máº¡ng lÆ°á»›i Ä‘Æ°á»ng (OSMnx)", page_icon="ğŸ—ºï¸", layout="centered")
st.title("ğŸ—ºï¸ TÃ­nh tá»•ng chiá»u dÃ i máº¡ng lÆ°á»›i Ä‘Æ°á»ng (KMU)")

st.markdown(
    """
Nháº­p **Ä‘á»‹a danh** Ä‘Ãºng nhÆ° trÃªn OpenStreetMap, vÃ­ dá»¥:
- `Danang, Vietnam`
- `Ho Chi Minh City, Vietnam`
- `Singapore`

Chá»n **network_type** Ä‘á»ƒ lá»c loáº¡i Ä‘Æ°á»ng muá»‘n láº¥y.
> Káº¿t quáº£ lÃ  tá»•ng chiá»u dÃ i *street_length_total* tá»« OSMnx (Ä‘á»•i sang **km**).
    """
)

# ===== Inputs =====
place = st.text_input("Äá»‹a danh (place):", value="Danang, Vietnam")
network_type = st.selectbox(
    "Loáº¡i máº¡ng lÆ°á»›i (network_type):",
    options=["all", "all_public", "drive", "drive_service", "walk", "bike"],
    index=0,
    help=(
        "â€¢ all: táº¥t cáº£ Ä‘Æ°á»ng (gá»“m háº»m, service road...)\n"
        "â€¢ all_public: chá»‰ Ä‘Æ°á»ng cÃ´ng cá»™ng\n"
        "â€¢ drive: Ä‘Æ°á»ng Ã´ tÃ´ cÃ´ng cá»™ng (loáº¡i trá»« service road)\n"
        "â€¢ drive_service: bao gá»“m service road\n"
        "â€¢ walk: Ä‘Æ°á»ng Ä‘i bá»™\n"
        "â€¢ bike: Ä‘Æ°á»ng cho xe Ä‘áº¡p"
    ),
)

# ===== Core logic (cache Ä‘á»ƒ trÃ¡nh táº£i láº¡i nhiá»u láº§n) =====
@st.cache_resource(show_spinner=False)
def load_graph(place_name: str, net_type: str):
    """Táº£i Ä‘á»“ thá»‹ Ä‘Æ°á»ng cá»§a 'place_name' theo 'net_type'."""
    G = ox.graph_from_place(place_name, network_type=net_type)
    return G

def compute_total_km(G) -> float:
    """TÃ­nh tá»•ng chiá»u dÃ i street_length_total (km) tá»« Ä‘á»“ thá»‹."""
    stats = ox.basic_stats(G, clean_int_tol=15)
    total_km = stats.get("street_length_total", 0.0) / 1000.0
    return total_km

# ===== Action =====
col1, col2 = st.columns([1, 1])
with col1:
    run = st.button("Táº£i & TÃ­nh toÃ¡n", type="primary")
with col2:
    show_map = st.toggle("Hiá»ƒn thá»‹ báº£n Ä‘á»“ Ä‘á»“ thá»‹", value=True)

if run:
    if not place.strip():
        st.error("Vui lÃ²ng nháº­p Ä‘á»‹a danh há»£p lá»‡.")
        st.stop()

    try:
        with st.spinner("Äang táº£i dá»¯ liá»‡u Ä‘Æ°á»ng tá»« OpenStreetMapâ€¦"):
            G = load_graph(place, network_type)

        total_km = compute_total_km(G)
        st.success(f"âœ… Tá»•ng chiá»u dÃ i máº¡ng lÆ°á»›i Ä‘Æ°á»ng (KMU): **{total_km:,.3f} km**")

        if show_map:
            st.caption("Báº£n Ä‘á»“ Ä‘á»“ thá»‹ (minh hoáº¡ nhanh):")
            fig, ax = ox.plot_graph(
                G,
                show=False, close=False,
                node_size=0, edge_linewidth=0.8, bgcolor="white"
            )
            st.pyplot(fig, clear_figure=True)

        with st.expander("Chi tiáº¿t & gá»£i Ã½"):
            st.markdown(
                "- Náº¿u bÃ¡o lá»—i **place khÃ´ng há»£p lá»‡**: tra cá»©u tÃªn chuáº©n trÃªn [openstreetmap.org](https://www.openstreetmap.org/) (Search) rá»“i thá»­ láº¡i.\n"
                "- Khu vá»±c quÃ¡ rá»™ng (cáº£ quá»‘c gia) cÃ³ thá»ƒ táº£i lÃ¢u â†’ nÃªn thu háº¹p theo *thÃ nh phá»‘/quáº­n/phÆ°á»ng*.\n"
                "- Thay Ä‘á»•i `network_type` Ä‘á»ƒ tÃ­nh theo má»¥c Ä‘Ã­ch (Ã´ tÃ´/Ä‘i bá»™/xe Ä‘áº¡p...)."
            )

    except Exception as e:
        st.error("CÃ³ lá»—i xáº£y ra khi táº£i/ tÃ­nh toÃ¡n. Chi tiáº¿t:")
        st.exception(e)
else:
    st.info("Nháº­p Ä‘á»‹a danh vÃ  báº¥m **Táº£i & TÃ­nh toÃ¡n** Ä‘á»ƒ báº¯t Ä‘áº§u.")
